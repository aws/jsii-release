#!/bin/bash
set -eu

###
#
# Pushes a golang module to a GitHub repository.
#
# Usage: ./jsii-release-golang [DIR]
#
# DIR: directory where the golang module is located (default is `dist/go`).
#
# GITHUB_TOKEN       (required): Authentication token that allows to push and tag the repository.
# GITHUB_REPO        (required): GitHub repository to push to.
# VERSION            (required): Module version. Will be used as the repository tag. Required unless NO_TAG is set to a non-zero value.
# GIT_BRANCH         (optional): Branch to push to. Defaults to 'main'.
# GIT_USER_NAME      (optional): Username to perform the commit with. Defaults to the current username (git config user.name)
# GIT_USER_EMAIL     (optional): Email to perform the commit with. Defaults to the current email (git config user.email)
# GIT_COMMIT_MESSAGE (optional): The commit message. Defaults to the last commit of the current repository.
###

dir=${1:-dist/go}
GIT_BRANCH=${GIT_BRANCH:-main}
GIT_USER_NAME=${GIT_USER_NAME:-$(git config user.name)}
GIT_USER_EMAIL=${GIT_USER_EMAIL:-$(git config user.email)}
GIT_COMMIT_MESSAGE=${GIT_COMMIT_MESSAGE:-$(git log -1 --format=%s)}

# remember the full path since we might be changing dirs later on
dir="$(pwd)/${dir}"

error() { echo "‚ùå $@"; exit 1; }

if [ ! -f "${dir}/go.mod" ]; then
  error "cannot find go.mod file in ${dir}/go.mod"
fi

if [ -z "${GITHUB_TOKEN:-}" ]; then
  error "GITHUB_TOKEN env variable is required"
fi

if [ -z "${GITHUB_REPO:-}" ]; then
  error "GITHUB_REPO env variable is required (owner/repo)"
fi

if [ -z "${VERSION:-}" ]; then
  error "VERSION env variable is required"
fi

target_repo_dir=$(mktemp -d)/repo

echo "Cloning target repository ${GITHUB_REPO}"
git clone https://${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git ${target_repo_dir}

pushd ${target_repo_dir}
git config user.name ${GIT_USER_NAME}
git config user.email ${GIT_USER_EMAIL}

git checkout ${GIT_BRANCH}

echo "Copying go module to repository root"
cp -r ${dir} .

git add .
git commit -m "\"${GIT_COMMIT_MESSAGE}\""
git push origin ${GIT_BRANCH}
git tag -a $VERSION -m $VERSION
git push origin $VERSION

popd